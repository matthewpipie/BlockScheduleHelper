/* Block Schedule Helper - A simple app to keep track of block schedules.
 * Copyright (C) 2016 Matthew Giordano
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 * 
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Contact the creator (Matthew Giordano) at matthewpipie@gmail.com.
 */
"use strict";var timeouts=[],setUpSettings={twelveHourTime:!1,pushNotifications:!1,dateformat:0,daysperweek:7,ready:!1,day:!1,pagecontainerbeforeshow:function(){},deviceready:function(){setUpSettings.loadSettings(),setUpSettings.updateSettings(),$("#formsubmit").on("touchend",function(a){addmenu.checkOpen()||(a.preventDefault(),setUpSettings.handleSubmit())}),$("#formdays").change(setUpSettings.verifyDay),$("#formtoday").change(setUpSettings.verifyToday),$("#formreset").on("touchend",function(a){addmenu.checkOpen()||(a.preventDefault(),setUpSettings.confirmReset())}),$("#formreset2").on("touchend",function(a){addmenu.checkOpen()||(a.preventDefault(),setUpSettings.confirmReset2())});var a=new Date;6!=a.getDay()&&0!=a.getDay()||$("#mondayOrToday").text("Monday")},updateSettings:function(){return setUpSettings.ready?($("#formtime")[0].checked=setUpSettings.twelveHourTime,$("#formtime").flipswitch("refresh"),$("#formnotifications")[0].checked=setUpSettings.pushNotifications,$("#formnotifications").flipswitch("refresh"),$("#formselect").val(setUpSettings.dateformat).change(),$("#formdays").val(setUpSettings.daysperweek),dateConverter.currentDate=new Date,dateConverter.getDay(),void setTimeout(setUpSettings.checkDateRan,10)):void setTimeout(setUpSettings.updateSettings,10)},verifyDay:function(){$("#formdays").val()&&$("#formdays").val()==parseInt($("#formdays").val())?parseInt($("#formdays").val())<1&&$("#formdays").val(1):$("#formdays").val(7),setUpSettings.verifyToday()},verifyToday:function(){var a=parseInt($("#formdays").val()),b=parseInt($("#formtoday").val());$("#formtoday").val()&&$("#formtoday").val()==parseInt($("#formtoday").val())||(b=1),b>a&&(b%=a),b<1&&(b=a),$("#formtoday").val(b)},confirmReset:function(){navigator.notification.confirm("Are you sure you would like to delete your schedule?  This can NOT be undone.",setUpSettings.handleReset,"Reset Schedule")},confirmReset2:function(){navigator.notification.confirm("Are you sure you would like to delete your schedule and all of your classes?  This can NOT be undone.",setUpSettings.handleReset2,"Reset Everything")},handleReset:function(a){1==a&&(localforage.setItem("schedule",void 0),localforage.setItem("globalSchedule",void 0),navigator.notification.alert("Schedule deleted."))},handleReset2:function(a){1==a&&(localforage.setItem("schedule",[]),localforage.setItem("globalSchedule",void 0),localforage.setItem("schoolClasses",void 0),navigator.notification.alert("Schedule and classes deleted."))},scheduleNextEventAndClear:function(a,b){void 0==b&&(b=!1),localforage.getItem("schoolClasses").then(function(a){localforage.getItem("schedule").then(function(c){localforage.getItem("globalSchedule").then(function(d){localforage.getItem("daysperweek").then(function(e){localforage.getItem("dateday").then(function(f){void 0==a&&(a=[],localforage.setItem("schoolClasses",a)),void 0==c&&(c=[],localforage.setItem("schedule",c)),void 0==d&&(d=[],localforage.setItem("globalSchedule",d)),void 0==e&&(e=7,localforage.setItem("daysperweek",e)),void 0==f&&(f={date:(new Date).toString(),day:0});for(var g=new Date,h=0;h<timeouts.length;h++)clearTimeout(timeouts[h]);var i=setUpSettings.calculateDay(f,e,new Date);void 0==c[i]&&(c[i]=[]);for(var j=[],k=0;k<c[i].length;k++){var l=c[i][k].starttime;l=60*parseInt(l.substr(0,2))+parseInt(l.substr(3));var m=c[i][k].endtime;m=60*parseInt(m.substr(0,2))+parseInt(m.substr(3)),j.push({id:c[i][k].id,starttime:l,endtime:m,isGlobal:!1})}for(var h=0;h<d.length;h++){var l=d[h].starttime;l=60*parseInt(l.substr(0,2))+parseInt(l.substr(3));var m=d[h].endtime;m=60*parseInt(m.substr(0,2))+parseInt(m.substr(3)),j.push({id:d[h].id,starttime:l,endtime:m,isGlobal:!0})}var q,h,k,n=j.sort(function(a,b){return parseInt(a.starttime,10)-parseInt(b.starttime,10)}),o=j.sort(function(a,b){return parseInt(a.endtime,10)-parseInt(b.endtime,10)}),p=60*g.getHours()+g.getMinutes(),r=!0,s=!1,t=!1,u=!1;for(h=p;h<1439;h++)if(n.filter(function(a){return a.starttime==h}).length){if(s){t=!0;break}q=h,s=!0}else;if(s||(r=!1),b){var v=n.filter(function(a){return a.starttime<p&&a.endtime>p});(q-p>10||0!=v.length)&&(h=q,t=!0),6!=g.getDay()&&0!=g.getDay()||(r=!1)}if(t||(r=!1),b&&q-p>10)k=h-10,u=!0;else for(k=h;k>=0;k--)if(o.filter(function(a){return a.endtime==k}).length){u=!0;break}u||(r=!1);var w,x,y,z=new Date;if(r)w=h,x=k,w-x>10&&(x=w-10),y=n.filter(function(a){return a.starttime==w})[0],z.setHours(0),z.setSeconds(0),z.setMilliseconds(0),z.setMinutes(x);else{console.log("no bueno");var A=new Date;A.setHours(A.getHours()+24),i=setUpSettings.calculateDay(f,e,A);var C,B=!1;for(C=1;C<29;C++){if(console.log(i),console.log(A),void 0==c[i]&&(c[i]=[]),0!=c[i].length&&A.getDay()<6&&A.getDay()>0){console.log("we out fam"),B=!0;break}console.log("stuck in eternal poo"),A.setHours(A.getHours()+24),i=setUpSettings.calculateDay(f,e,A)}if(!B)return $("#formnotifications")[0].checked=!1,$("#formnotifications").flipswitch("refresh"),navigator.notification.alert("Error: Please create a schedule first."),void setUpSettings.handleSubmit();j=[];for(var k=0;k<c[i].length;k++){var l=c[i][k].starttime;l=60*parseInt(l.substr(0,2))+parseInt(l.substr(3));var m=c[i][k].endtime;m=60*parseInt(m.substr(0,2))+parseInt(m.substr(3)),j.push({id:c[i][k].id,starttime:l,endtime:m,isGlobal:!1})}for(var h=0;h<d.length;h++){var l=d[h].starttime;l=60*parseInt(l.substr(0,2))+parseInt(l.substr(3));var m=d[h].endtime;m=60*parseInt(m.substr(0,2))+parseInt(m.substr(3)),j.push({id:d[h].id,starttime:l,endtime:m,isGlobal:!0})}if(n=j.sort(function(a,b){return parseInt(a.starttime,10)-parseInt(b.starttime,10)}),console.log(n),0==n.length)return;w=n[0].starttime,console.log(w),x=w-10,y=n[0],z=A,z.setHours(0),z.setSeconds(0),z.setMilliseconds(0),z.setMinutes(x),p=-(1440*C)}y=y.isGlobal?d.filter(function(a){return a.id==y.id})[0]:c[i].filter(function(a){return a.id==y.id})[0],timeouts.push(setTimeout(function(){cordova.plugins.notification.local.clearAll()},6e4*(w-p)));var D=setUpSettings.findClass(a,y.className,"bgcolor");console.log(z);var E="Next class: "+setUpSettings.findClass(a,y.className,"className")+(""==setUpSettings.findClass(a,y.className,"room")?"":" ("+setUpSettings.findClass(a,y.className,"room")+")"),F="Starts in "+(w-x).toString()+" minutes";g.toDateString()!=z.toDateString()&&(F=E+" in 10",E="Today is day "+(parseInt(i)+1).toString());var G={id:0,title:E,text:F,at:z,led:null==D?"FFFFFF":D.substr(1)};console.log(G),console.log(w),console.log(w-p),cordova.plugins.notification.local.schedule(G),b&&navigator.notification.alert("Notifications have been turned on.")})})})})})},findClass:function(a,b,c){for(var d=0;d<a.length;d++)if(a[d].id==b)return a[d][c]},calculateDay:function(a,b,c){var d=0,e=new Date(a.date),f=a.day;return d=e<c?dateConverter.newGBDC(e,c)-1:-dateConverter.newGBDC(c,e)+1,d+=f,d%=b,d<0&&(d+=b),d},handleSubmit:function(){console.log("saving"),setUpSettings.verifyDay();var a=$("#formtime")[0].checked,b=$("#formnotifications")[0].checked,c=$("#formselect").val(),d=$("#formdays").val(),e=$("#formtoday").val();localforage.setItem("twelveHourTime",a),localforage.setItem("pushNotifications",b),localforage.setItem("dateformat",parseInt(c)),localforage.setItem("daysperweek",parseInt(d)),localforage.setItem("currentDay",parseInt(e)),dateConverter.setDateDay("",parseInt(e)-1),b&&!setUpSettings.pushNotifications?cordova.plugins.notification.local.cancelAll(function(){setUpSettings.scheduleNextEventAndClear(null,!0)}):!b&&setUpSettings.pushNotifications&&cordova.plugins.notification.local.cancelAll(function(){navigator.notification.alert("Notifications have been turned off.")}),setUpSettings.twelveHourTime=a,setUpSettings.pushNotifications=b,setUpSettings.dateformat=c,setUpSettings.daysperweek=d,navigator.notification.alert("Settings saved.")},loadSettings:function(){localforage.getItem("twelveHourTime").then(function(a){void 0==a&&(a=!1,localforage.setItem("twelveHourTime",a)),localforage.getItem("pushNotifications").then(function(b){void 0==b&&(b=!1,localforage.setItem("pushNotifications",b)),localforage.getItem("dateformat").then(function(c){void 0==c&&(c=0,localforage.setItem("dateformat",c)),localforage.getItem("daysperweek").then(function(d){void 0==d&&(d=7,localforage.setItem("daysperweek",d)),setUpSettings.twelveHourTime=a,setUpSettings.pushNotifications=b,setUpSettings.dateformat=c,setUpSettings.daysperweek=d,setUpSettings.ready=!0})})})})},checkDateRan:function(){if(dateConverter.firstTime)return void setTimeout(setUpSettings.checkDateRan,10);var a=1;6!=(new Date).getDay()&&0!=(new Date).getDay()||(a=2),$("#formtoday").val(dateConverter.firstDay+a),setUpSettings.verifyToday(),setUpSettings.day=dateConverter.firstDay}};